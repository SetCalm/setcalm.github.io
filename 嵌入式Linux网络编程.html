<!DOCTYPE html>












  


<html class="theme-next mist use-motion" lang="zh-CN">
<head><meta name="generator" content="Hexo 3.8.0">
  <meta charset="UTF-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">












<meta http-equiv="Cache-Control" content="no-transform">
<meta http-equiv="Cache-Control" content="no-siteapp">






















<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css">

<link href="/css/main.css?v=6.5.0" rel="stylesheet" type="text/css">


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png?v=6.5.0">


  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png?v=6.5.0">


  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png?v=6.5.0">


  <link rel="mask-icon" href="/images/logo.svg?v=6.5.0" color="#222">









<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Mist',
    version: '6.5.0',
    sidebar: {"position":"left","display":"post","offset":12,"b2t":false,"scrollpercent":false,"onmobile":false},
    fancybox: false,
    fastclick: false,
    lazyload: false,
    tabs: true,
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>


  




  <meta name="description" content="嵌入式 Linux 网络编程第一章：TCP/IP 协议简介TCP/IP 协议概述OSI 参考模型及 TCP/IP 参考模型OSI 协议参考模型是基于国际标准化组织（ISO）的建议发展起来的，从上到下共分为 7 层：应用层、表示层、会话层、传输 层、 网络层、数据链路层及物理层。这个 7 层的协议模型虽然规 定得非常细致和完善，但在实际中却得不到广泛的应用，其重 要的原因之一就在于它过于复杂。但它仍">
<meta name="keywords" content="暂时无">
<meta property="og:type" content="article">
<meta property="og:title" content="Jeff">
<meta property="og:url" content="https://github.com/SetCalm/setcalm.github.io/嵌入式Linux网络编程.html">
<meta property="og:site_name" content="Jeff">
<meta property="og:description" content="嵌入式 Linux 网络编程第一章：TCP/IP 协议简介TCP/IP 协议概述OSI 参考模型及 TCP/IP 参考模型OSI 协议参考模型是基于国际标准化组织（ISO）的建议发展起来的，从上到下共分为 7 层：应用层、表示层、会话层、传输 层、 网络层、数据链路层及物理层。这个 7 层的协议模型虽然规 定得非常细致和完善，但在实际中却得不到广泛的应用，其重 要的原因之一就在于它过于复杂。但它仍">
<meta property="og:locale" content="zh-CN">
<meta property="og:image" content="d:/MyBlog/图片/Snipaste_2019-03-04_13-23-01.png">
<meta property="og:image" content="d:/MyBlog/图片/Snipaste_2019-03-04_13-29-39.png">
<meta property="og:image" content="d:/MyBlog/图片/Snipaste_2019-03-04_14-25-58.png">
<meta property="og:image" content="d:/MyBlog/图片/Snipaste_2019-03-04_15-00-34.png">
<meta property="og:image" content="d:/MyBlog/图片/Snipaste_2019-03-04_15-38-40.png">
<meta property="og:image" content="d:/MyBlog/图片/Snipaste_2019-03-04_16-18-06.png">
<meta property="og:image" content="d:/MyBlog/图片/Snipaste_2019-03-04_16-07-27.png">
<meta property="og:image" content="d:/MyBlog/图片/Snipaste_2019-03-04_16-33-59.png">
<meta property="og:image" content="d:/MyBlog/图片/Snipaste_2019-03-04_16-34-11.png">
<meta property="og:image" content="d:/MyBlog/图片/Snipaste_2019-03-04_16-34-18.png">
<meta property="og:image" content="d:/MyBlog/图片/Snipaste_2019-03-05_16-08-41.png">
<meta property="og:image" content="d:/MyBlog/图片/Snipaste_2019-03-05_16-08-24.png">
<meta property="og:image" content="d:/MyBlog/图片/Snipaste_2019-03-05_14-28-51.png">
<meta property="og:image" content="d:/MyBlog/图片/Snipaste_2019-03-05_14-31-47.png">
<meta property="og:image" content="d:/MyBlog/图片/Snipaste_2019-03-05_14-29-05.png">
<meta property="og:image" content="d:/MyBlog/图片/Snipaste_2019-03-05_14-29-12.png">
<meta property="og:image" content="d:/MyBlog/图片/Snipaste_2019-03-05_14-29-19.png">
<meta property="og:image" content="d:/MyBlog/图片/Snipaste_2019-03-05_14-29-27.png">
<meta property="og:image" content="d:/MyBlog/图片/Snipaste_2019-03-05_14-29-33.png">
<meta property="og:image" content="d:/MyBlog/图片/Snipaste_2019-03-05_14-29-42.png">
<meta property="og:image" content="d:/MyBlog/图片/Snipaste_2019-03-05_14-29-49.png">
<meta property="og:image" content="d:/MyBlog/图片/Snipaste_2019-03-05_16-23-50.png">
<meta property="og:image" content="d:/MyBlog/图片/Snipaste_2019-03-05_17-18-16.png">
<meta property="og:updated_time" content="2019-03-05T14:25:24.846Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Jeff">
<meta name="twitter:description" content="嵌入式 Linux 网络编程第一章：TCP/IP 协议简介TCP/IP 协议概述OSI 参考模型及 TCP/IP 参考模型OSI 协议参考模型是基于国际标准化组织（ISO）的建议发展起来的，从上到下共分为 7 层：应用层、表示层、会话层、传输 层、 网络层、数据链路层及物理层。这个 7 层的协议模型虽然规 定得非常细致和完善，但在实际中却得不到广泛的应用，其重 要的原因之一就在于它过于复杂。但它仍">
<meta name="twitter:image" content="d:/MyBlog/图片/Snipaste_2019-03-04_13-23-01.png">



  <link rel="alternate" href="/atom.xml" title="Jeff" type="application/atom+xml">




  <link rel="canonical" href="https://github.com/SetCalm/setcalm.github.io/嵌入式Linux网络编程.html">



<script type="text/javascript" id="page.configurations">
  CONFIG.page = {
    sidebar: "",
  };
</script>

  <title> | Jeff</title>
  











  <noscript>
  <style type="text/css">
    .use-motion .motion-element,
    .use-motion .brand,
    .use-motion .menu-item,
    .sidebar-inner,
    .use-motion .post-block,
    .use-motion .pagination,
    .use-motion .comments,
    .use-motion .post-header,
    .use-motion .post-body,
    .use-motion .collection-title { opacity: initial; }

    .use-motion .logo,
    .use-motion .site-title,
    .use-motion .site-subtitle {
      opacity: initial;
      top: initial;
    }

    .use-motion {
      .logo-line-before i { left: initial; }
      .logo-line-after i { right: initial; }
    }
  </style>
</noscript>

</head>

<body itemscope="" itemtype="http://schema.org/WebPage" lang="zh-CN">

  
  
    
  

  <div class="container sidebar-position-left page-post-detail">
    <div class="headband"></div>

      <a href="https://github.com/SetCalm" class="github-corner" aria-label="View source on GitHub"><svg width="80" height="80" viewbox="0 0 250 250" style="fill:#151513; color:#fff; position: absolute; top: 0; border: 0; right: 0;" aria-hidden="true"><path d="M0,0 L115,115 L130,115 L142,142 L250,250 L250,0 Z"/><path d="M128.3,109.0 C113.8,99.7 119.0,89.6 119.0,89.6 C122.0,82.7 120.5,78.6 120.5,78.6 C119.2,72.0 123.4,76.3 123.4,76.3 C127.3,80.9 125.5,87.3 125.5,87.3 C122.9,97.6 130.6,101.9 134.4,103.2" fill="currentColor" style="transform-origin: 130px 106px;" class="octo-arm"/><path d="M115.0,115.0 C114.9,115.1 118.7,116.5 119.8,115.4 L133.7,101.6 C136.9,99.2 139.9,98.4 142.2,98.6 C133.8,88.0 127.5,74.4 143.8,58.0 C148.5,53.4 154.0,51.2 159.7,51.0 C160.3,49.4 163.2,43.6 171.4,40.1 C171.4,40.1 176.1,42.5 178.8,56.2 C183.1,58.6 187.2,61.8 190.9,65.4 C194.5,69.0 197.7,73.2 200.1,77.6 C213.8,80.2 216.3,84.9 216.3,84.9 C212.7,93.1 206.9,96.0 205.4,96.6 C205.1,102.4 203.0,107.8 198.3,112.5 C181.9,128.9 168.3,122.5 157.7,114.1 C157.9,116.9 156.7,120.9 152.7,124.9 L141.0,136.5 C139.8,137.7 141.6,141.9 141.8,141.8 Z" fill="currentColor" class="octo-body"/></svg></a><style>.github-corner:hover .octo-arm{animation:octocat-wave 560ms ease-in-out}@keyframes octocat-wave{0%,100%{transform:rotate(0)}20%,60%{transform:rotate(-25deg)}40%,80%{transform:rotate(10deg)}}@media (max-width:500px){.github-corner:hover .octo-arm{animation:none}.github-corner .octo-arm{animation:octocat-wave 560ms ease-in-out}}</style>

    <header id="header" class="header" itemscope="" itemtype="https://github.com/SetCalm">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/" class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">Jeff</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
    
  </div>

  <div class="site-nav-toggle">
    <button aria-label="切换导航栏">
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>



<nav class="site-nav">
  
    <ul id="menu" class="menu">
      
        
        
        
          
          <li class="menu-item menu-item-home">
    <a href="/" rel="section">
      <i class="menu-item-icon fa fa-fw fa-home"></i> <br>首页</a>
  </li>
        
        
        
          
          <li class="menu-item menu-item-student">
    <a href="/student" rel="section">
      <i class="menu-item-icon fa fa-fw fa-question-circle"></i> <br>学习</a>
  </li>
        
        
        
          
          <li class="menu-item menu-item-life">
    <a href="/life" rel="section">
      <i class="menu-item-icon fa fa-fw fa-question-circle"></i> <br>生活</a>
  </li>
        
        
        
          
          <li class="menu-item menu-item-musicbooksfilms">
    <a href="/MusicBooksFilms" rel="section">
      <i class="menu-item-icon fa fa-fw fa-question-circle"></i> <br>影音书</a>
  </li>
        
        
        
          
          <li class="menu-item menu-item-collect">
    <a href="/collect" rel="section">
      <i class="menu-item-icon fa fa-fw fa-question-circle"></i> <br>收藏</a>
  </li>
        
        
        
          
          <li class="menu-item menu-item-about">
    <a href="/about/" rel="section">
      <i class="menu-item-icon fa fa-fw fa-user"></i> <br>关于</a>
  </li>
        
        
        
          
          <li class="menu-item menu-item-tags">
    <a href="/tags/" rel="section">
      <i class="menu-item-icon fa fa-fw fa-tags"></i> <br>标签</a>
  </li>
        
        
        
          
          <li class="menu-item menu-item-categories">
    <a href="/categories/" rel="section">
      <i class="menu-item-icon fa fa-fw fa-th"></i> <br>分类</a>
  </li>
        
        
        
          
          <li class="menu-item menu-item-archives">
    <a href="/archives/" rel="section">
      <i class="menu-item-icon fa fa-fw fa-archive"></i> <br>归档</a>
  </li>

      
      
    </ul>
  

  
    

  

  
</nav>



  



</div>
    </header>

    


    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          
          <div id="content" class="content">
            

  <div id="posts" class="posts-expand">
    

  

  
  
  

  

  <article class="post post-type-normal" itemscope="" itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://github.com/SetCalm/setcalm.github.io/嵌入式Linux网络编程.html">

    <span hidden itemprop="author" itemscope="" itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Jeff Wu">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope="" itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Jeff">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">

            
            
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              

              
                
              

              <time title="创建时间：2019-03-04 13:07:52" itemprop="dateCreated datePublished" datetime="2019-03-04T13:07:52+08:00">2019-03-04</time>
            

            
              

              
                
                <span class="post-meta-divider">|</span>
                

                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                
                  <span class="post-meta-item-text">更新于</span>
                
                <time title="修改时间：2019-03-05 22:25:24" itemprop="dateModified" datetime="2019-03-05T22:25:24+08:00">2019-03-05</time>
              
            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        <h1 id="嵌入式-Linux-网络编程"><a href="#嵌入式-Linux-网络编程" class="headerlink" title="嵌入式 Linux 网络编程"></a>嵌入式 Linux 网络编程</h1><h2 id="第一章：TCP-IP-协议简介"><a href="#第一章：TCP-IP-协议简介" class="headerlink" title="第一章：TCP/IP 协议简介"></a>第一章：TCP/IP 协议简介</h2><h3 id="TCP-IP-协议概述"><a href="#TCP-IP-协议概述" class="headerlink" title="TCP/IP 协议概述"></a>TCP/IP 协议概述</h3><h4 id="OSI-参考模型及-TCP-IP-参考模型"><a href="#OSI-参考模型及-TCP-IP-参考模型" class="headerlink" title="OSI 参考模型及 TCP/IP 参考模型"></a>OSI 参考模型及 TCP/IP 参考模型</h4><p>OSI 协议参考模型是基于国际标准化组织（ISO）的建议发展起来的，从上<br>到下共分为 7 层：应用层、表示层、会话层、传输 层、 网络层、<br>数据链路层及物理层。这个 7 层的协议模型虽然规 定得非常细<br>致和完善，但在实际中却得不到广泛的应用，其重 要的原因之<br>一就在于它过于复杂。但它仍是此后很多协议模型 的基础，这<br>种分层架构的思想在很多领域都得到了广泛的应 用。</p>
<a id="more"></a>
<p>与此相区别的 TCP/IP 协议模型从一开始就遵循简单明 确的设计思<br>路，它将 TCP/IP 的 7 层协议模型简化为 4 层，从而更 有利于实现<br>和使用。 TCP/IP 的协议参考模型和 OSI 协议参考模型 的对应关系<br>如图10.1 所示。 </p>
<p><img src="D:\MyBlog\图片\Snipaste_2019-03-04_13-23-01.png" alt="Snipaste_2019-03-04_13-23-01"></p>
<h4 id="TCP-IP-的-4-层模型进行简要介绍"><a href="#TCP-IP-的-4-层模型进行简要介绍" class="headerlink" title="TCP/IP 的 4 层模型进行简要介绍"></a>TCP/IP 的 4 层模型进行简要介绍</h4><p><strong>网络接口层：</strong>负责将二进制流转换为数据帧，并进行数据帧的发送和接收。要注意的是数据帧是<br>独立的网络信息传输单元。</p>
<p><strong>网络层：</strong>负责将数据帧封装成 IP 数据包，并运行必要的路由算法。</p>
<p><strong>传输层：</strong>负责端对端之间的通信会话连接与建立。传输协议的选择根据数据传输方式而定。</p>
<p><strong>应用层：</strong>负责应用程序的网络访问，这里通过端口号来识别各个不同的进程。 </p>
<h4 id="TCP-IP概述"><a href="#TCP-IP概述" class="headerlink" title="TCP/IP概述"></a>TCP/IP概述</h4><p>因特网在传输层有两种主要的协议：一种是面向连接的协议，一种是无连接的协议。传输控制协议TCP是(transmission control protocol)专门用于在不可靠的因特网上提供可靠的、端对端的字节流通信的协议。通过在发送方和接收方分别创建一个称为套接字的通信端口就可以获得TCP服务。所有的TCP 连接均是全双工的和点到点的。（tcp/ip提供可靠，全双工的和点到点连接）</p>
<p>TCP 数据传输实<br>现了从一个应用程序到另一个应用程序的数据传递。应用程序通过编程调用 TCP 并使用 TCP 服务，提供需要准<br>备发送的数据，用来区分接收数据应用的目的地址和端口号。 </p>
<p>通常应用程序通过打开一个 socket 来使用 TCP 服务， TCP 管理到其他 socket 的数据传递。</p>
<p>可以说：</p>
<ul>
<li>通过<br>IP 的源/目的可以惟一地区分网络中两个设备的连接</li>
<li>通过 socket 的源/目的可以惟一地区分网络中两个应<br>用程序的连接。 </li>
</ul>
<p>虽然 TCP/IP 名称只包含了两个协议，但实际上， TCP/IP 是 一 个 庞<br>大的协议族，它包括了各个层次上的众多协议，</p>
<p>图10.2 列 举 了 各<br>层中一些重要的协议， 并给出了各个协议在不同层次中所 处的位置，<br>如下所示。 </p>
<p><img src="D:\MyBlog\图片\Snipaste_2019-03-04_13-29-39.png" alt="Snipaste_2019-03-04_13-29-39"></p>
<h3 id="TCP"><a href="#TCP" class="headerlink" title="TCP"></a>TCP</h3><h4 id="TCP数据报头"><a href="#TCP数据报头" class="headerlink" title="TCP数据报头"></a>TCP数据报头</h4><p>该部分参考自：<a href="https://www.cnblogs.com/renzimu/p/3868747.html" target="_blank" rel="noopener">TCP/IP原理、基础以及在Linux上的实现</a></p>
<p>发送和接收方TCP实体以数据报的形式交换数据。一个数据报包含一个固定的20字节的头、一个可选部分以及0或多字节的数据。对数据报的大小有两个限制条件：首先，每个数据报（包括TCP头在内）必须适合IP的载荷能力，不能超过65535字节；其次，每个网络都存在最大传输单元MTU（maximum transfer unit），要求每个数据报必须适合MTU。如果一个数据报进入了一个MTU小于该数据报长度的网络，那么处于网络边界上的路由器会把该数据报分解为多个小的数据报。</p>
<p>TCP实体所采用的基本协议是滑动窗口协议。当发送方传送一个数据报时，它将启动计时器。当该数据报到达目的地后，接收方的TCP实体向回发送一个数据报，其中包含有一个确认序号，它等于希望收到的下一个数据报的顺序号。如果发送方的定时器在确认信息到达之前超时，那么发送方会重发该数据报。</p>
<p>下图给出了TCP数据报头的格式。</p>
<p><img src="D:\MyBlog\图片\Snipaste_2019-03-04_14-25-58.png" alt="Snipaste_2019-03-04_14-25-58"></p>
<p><strong>源端口、目的端口：</strong>16位长。标识出远端和本地的端口号。</p>
<p><strong>顺序号：</strong>32位长。表明了发送的数据报的顺序。</p>
<p><strong>确认号：</strong>32位长。希望收到的下一个数据报的序列号。</p>
<p><strong>TCP头长：</strong>4位长。表明TCP头中包含多少个32位字。</p>
<p>接下来的6位未用。 </p>
<p><strong>ACK（表示响应）：</strong>ACK位置1表明确认号是合法的。如果ACK为0，那么数据报不包含确认信息，确认字段被省略。</p>
<p><strong>PSH（表示有 DATA数据传输）：</strong>表示是带有PUSH标志的数据。接收方因此请求数据报一到便可送往应用程序而不必等到缓冲区装满时才传送。</p>
<p><strong>RST（表示连接重置）：</strong>用于复位由于主机崩溃或其它原因而出现的错误的连接。还可以用于拒绝非法的数据报或拒绝连接请求。</p>
<p><strong>SYN（表示建立连接）：</strong>用于建立连接。</p>
<p><strong>FIN（表示关闭连接）：</strong>用于释放连接。</p>
<p><strong>窗口大小：</strong>16位长。窗口大小字段表示在确认了字节之后还可以发送多少个字节。</p>
<p><strong>校验和：</strong>16位长。是为了确保高可靠性而设置的。它校验头部、数据和伪TCP头部之和。</p>
<p><strong>可选项：</strong>0个或多个32位字。包括最大TCP载荷，窗口比例、选择重发数据报等选项。</p>
<ol>
<li>最大TCP载荷：允许每台主机设定其能够接受的最大的TCP载荷能力。在建立连接期间，双方均声明其最大载荷能力，并选取其中较小的作为标准。如果一台主机未使用该选项，那么其载荷能力缺省设置为536字节。</li>
<li>窗口比例：允许发送方和接收方商定一个合适的窗口比例因子。这一因子使滑动窗口最大能够达到232字节。</li>
<li>选择重发数据报：这个选项允许接收方请求发送指定的一个或多个数据报。</li>
</ol>
<p><strong>注：</strong>其中，ACK是可能与SYN，FIN等同时使用的，比如SYN和ACK可能同时为1，它表示的就是建立连接之后的响应，</p>
<p><em>如果只是单个的一个SYN，它表示的只是建立连接。</em></p>
<p><em>TCP的几次握手就是通过这样的ACK表现出来的。</em></p>
<p><em>但SYN与FIN是不会同时为1的，因为前者表示的是建立连接，而后者表示的是断开连接。</em></p>
<p><em>RST一般是在FIN之后才会出现为1的情况，表示的是连接重置。</em></p>
<p><em>一般地，当出现FIN包或RST包时，我们便认为客户端与服务器端断开了连接；而当出现SYN和SYN＋ACK包时，我们认为客户端与服务器建立了一个连接。</em></p>
<p><em>PSH为1的情况，一般只出现在 DATA内容不为0的包中，也就是说PSH为1表示的是有真正的TCP数据包内容被传递。</em></p>
<h4 id="IP数据报头"><a href="#IP数据报头" class="headerlink" title="IP数据报头"></a>IP数据报头</h4><p>略</p>
<h4 id="三次握手"><a href="#三次握手" class="headerlink" title="三次握手"></a>三次握手</h4><p><em>SYN</em>：同步序列编号（<em>Syn</em>chronize Sequence Numbers）。是TCP/IP建立连接时使用的握手信号。表示建立连接。</p>
<p>seq是顺序号，ack是确认号，大小均为4字节</p>
<p>TCP的连接建立和连接关闭，都是通过请求－响应的模式完成的。</p>
<ul>
<li>初始化主机通过一个同步标志置位（SYN）的数据段发出会话请求，及随机顺序号(seq)。</li>
<li>接收主机通过发回具有以下项目的数据段表示回复：同步标志置位（SYN）、即将发送的数据段的起始字<br>节的顺序号(seq)、应答（ACK）并带有将收到的下一个数据段的字节顺序号。</li>
<li>请求主机再回送一个数据段，并带有确认顺序号和确认号。 </li>
</ul>
<p>完成三次握手，主机A与主机B开始传送数据。</p>
<p><img src="D:\MyBlog\图片\Snipaste_2019-03-04_15-00-34.png" alt="Snipaste_2019-03-04_15-00-34"></p>
<h4 id="四步挥手"><a href="#四步挥手" class="headerlink" title="四步挥手"></a>四步挥手</h4><h3 id="UDP"><a href="#UDP" class="headerlink" title="UDP"></a>UDP</h3><p>略</p>
<h2 id="第二章：网络编程基础"><a href="#第二章：网络编程基础" class="headerlink" title="第二章：网络编程基础"></a>第二章：网络编程基础</h2><p>我们熟悉了各种Linux 系统所提供的经典进程间通信 机制（ IPC）： 管道、 FIFO、 消息 队列、 信号量 以及共享存储。 这些机制允许在同一台计算 机上运行的进程可以相互通信。 本章将学会不同计算机（ 通过网络相连）上的进程相互通信的机制： 网络进程间通信（ network IPC）。</p>
<p>我们将熟悉套接字网络进程间通信接口， 进程用该 接口能够和其他进程通信， 无论它们是在同 一台计算机上还是在不同的计算机上。</p>
<h3 id="套接字描述符"><a href="#套接字描述符" class="headerlink" title="套接字描述符"></a>套接字描述符</h3><p>套接字是通信端点的抽象。正如使用文件描述符访问文件，应用程序用套接字描述符访问套接 字。套接字 描述符 在UNIX系统中被当作是一 种文件描述符。  许多 处理文件描述符的函数（ 如 read 和 write）也可以 用于处理套 接字描述符。 </p>
<p>创建一个套接字， </p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//调用 socket 函数。 </span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;sys/socket.h&gt;</span></span></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">socket</span> <span class="params">(<span class="keyword">int</span> domain, <span class="keyword">int</span> type, <span class="keyword">int</span> protocol)</span></span>; <span class="comment">//返回 值： 若 成功， 返回 文件（ 套 接 字） 描述 符； 若 出错， 返回 − 1</span></span><br></pre></td></tr></table></figure>
<h3 id="socket-概述"><a href="#socket-概述" class="headerlink" title="socket 概述"></a>socket 概述</h3><p><strong>socket 定义</strong> </p>
<p>在 Linux 中的网络编程是通过 socket 接口来进行的。人们常说的 socket 是一种特殊的 I/O 接口，它也是一<br>种文件描述符。 socket 是一种常用的进程之间通信机制，通过它不仅能实现本地机器上的进程之间的通信，<br>而且通过网络能够在不同机器上的进程之间进行通信。</p>
<p>每一个 socket 都用一个半相关描述{协议、本地地址、本地端口}来表示；一个完整的套接字则用一个相关<br>描述{协议、本地地址、本地端口、远程地址、远程端口}来表示。 socket 也有一个类似于打开文件的函数<br>调用，该函数返回一个整型的 socket 描述符，随后的连接建立、数据传输等操作都是通过 socket 来实现的。 </p>
<p><strong>socket 类型</strong> </p>
<p>常见的 socket 有 3 种类型如下。</p>
<ul>
<li><p><strong>流式 socket（SOCK_STREAM）</strong><br>流式套接字提供可靠的、面向连接的通信流；它使用 TCP 协议，从而保证了数据传输的正确性和顺序性。</p>
</li>
<li><p><strong>数据报 socket（SOCK_DGRAM）</strong><br>数据报套接字定义了一种无连接的服务，数据通过相互独立的报文进行传输，是无序的，并且不保证是可<br>靠、无差错的。它使用数据报协议 UDP。</p>
</li>
<li><strong>原始 socket</strong> 原始套接字允许对底层协议如 IP 或 ICMP 进行直接访问，它功能强大但使用较为不便，主要用于一些协议<br>的开发。 </li>
</ul>
<h3 id="字节序"><a href="#字节序" class="headerlink" title="字节序"></a>字节序</h3><p>在同一台计算机上的进程进行通信 时，一般不用考虑字节序。 字节序是 一个处理器架构特性，用 指示像整数这样的大数据类型内部的字节如何排序。</p>
<p>图 为一个32位整数的字节序</p>
<p><img src="D:\MyBlog\图片\Snipaste_2019-03-04_15-38-40.png" alt="Snipaste_2019-03-04_15-38-40"></p>
<p>如果处理器架构支持大端（ big- endian）字节序， 那么最大字节地址出现 在最低有效字节（ Least Significant Byte， LSB）上。</p>
<p> 小 端（ little- endian）字节序则相反：最低有效字节包含最小字节地址。</p>
<p>计算机数据存储有两种字节优先顺序：高位字节优先（称为大端模式）和低位字节优先（称为小端模式，<br>PC 机通常采用小端模式）。 Internet 上网络协议指定数据以高位字节优先顺序在网络上传输，所以应用程序有时需要在 处理器的字节序与网络字节序之间转换它们。这里用到了 4 个函数： htons()、 ntohs()、 htonl()和 ntohl()。这 4<br>个地址分别实现网络字节序和主机字节序的转化，这里的 h 代表 host， n 代表 network， s 代表 short， l 代<br>表 long。通常 16 位的 IP 端口号用 s 代表，而 IP 地址用 l 来代表  </p>
<p><strong>函数格式说明</strong> </p>
<p>下图列出了这 4 个函数的语法格式 </p>
<p><img src="D:\MyBlog\图片\Snipaste_2019-03-04_16-18-06.png" alt="Snipaste_2019-03-04_16-18-06"></p>
<h3 id="IP地址格式"><a href="#IP地址格式" class="headerlink" title="IP地址格式"></a>IP地址格式</h3><h4 id="IP地址的作用"><a href="#IP地址的作用" class="headerlink" title="IP地址的作用"></a>IP地址的作用</h4><p>IP地址是用来标识网络中的一台 主机。 一个 IP地址包含两部分： 网络号 和主机号。 其中，网络号和主机号根据子网掩码来区分。 简单地说， 有了源IP和目标IP， 数据包就能在不同的主机之间传输。</p>
<p>IP地址有两种不同格式：十进制点分形式和32位二进制形式。 前者是用户所熟悉 的形式， 而后者则是网络传输中IP地址的存储方式。</p>
<p> IPv4地址转换函数有 inet_ aton()、 inet_ addr() 和 inet_ ntoa()，而 IPv4和IPv6兼容的函数有 inet_ pton() 和 inet_ ntop()。（IPv6不介绍）</p>
<h4 id="IP地址转换函数"><a href="#IP地址转换函数" class="headerlink" title="IP地址转换函数"></a>IP地址转换函数</h4><p><strong>IP地址相关结构体</strong></p>
<p>首先在介绍IP地址转换函数时可能会用到以下的数据结构</p>
<p>数据类型： sockaddr 和 sockaddr_in， 这两个结构类型都是用来保存 socket 信息的，<br>如下所示： </p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">sockaddr</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">short</span> sa_family; <span class="comment">/*地址族*/</span></span><br><span class="line">	<span class="keyword">char</span> sa_data[<span class="number">14</span>]; <span class="comment">/*14 字节的协议地址，包含该socket 的IP 地址和端口号。 */</span></span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">sockaddr_in</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">	<span class="keyword">short</span> <span class="keyword">int</span> sa_family; <span class="comment">/*地址族*/</span></span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">short</span> <span class="keyword">int</span> sin_port; <span class="comment">/*端口号*/</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">in_addr</span> <span class="title">sin_addr</span>;</span> <span class="comment">/*IP 地址*/</span></span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">char</span> sin_zero[<span class="number">8</span>]; <span class="comment">/*填充 0 以保持与 struct sockaddr 同样大小*/</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这两个数据类型是等效的，可以相互转化，通常 sockaddr_in 数据类型使用更为方便。在建立 socketadd 或<br>sockaddr_in 后，就可以对该 socket 进行适当的操作了。 </p>
<p><strong>下面列出了该结构 sa_family 字段可选的常见值</strong> </p>
<p><img src="D:\MyBlog\图片\Snipaste_2019-03-04_16-07-27.png" alt="Snipaste_2019-03-04_16-07-27"></p>
<p><strong>下面介绍地址格式转化函数</strong></p>
<p><strong>inet_ addr()</strong></p>
<p><img src="D:\MyBlog\图片\Snipaste_2019-03-04_16-33-59.png" alt="Snipaste_2019-03-04_16-33-59"></p>
<hr>
<p><strong>inet_ pton()</strong></p>
<p><img src="D:\MyBlog\图片\Snipaste_2019-03-04_16-34-11.png" alt="Snipaste_2019-03-04_16-34-11"></p>
<p><strong>inet_ ntop()</strong></p>
<p><img src="D:\MyBlog\图片\Snipaste_2019-03-04_16-34-18.png" alt="Snipaste_2019-03-04_16-34-18"></p>
<h3 id="名字地址转化"><a href="#名字地址转化" class="headerlink" title="名字地址转化"></a>名字地址转化</h3><p>略</p>
<h2 id="第三章：socket编程实战"><a href="#第三章：socket编程实战" class="headerlink" title="第三章：socket编程实战"></a>第三章：socket编程实战</h2><p>推荐博客：<a href="https://www.cnblogs.com/PengfeiSong/p/6582998.html" target="_blank" rel="noopener">linux网络编程框架</a></p>
<h3 id="编程步骤"><a href="#编程步骤" class="headerlink" title="编程步骤"></a>编程步骤</h3><p>socket 编程的基本函数有 socket()、 bind()、 listen()、 accept()、 send()、 sendto()、 recv()以及 recvfrom()等，其<br>中根据客户端还是服务端，或者根据使用 TCP 协议还是 UDP 协议，这些函数的调用流程都有所区别，这里<br>先对每个函数进行说明，再给出各种情况下使用的流程图。</p>
<ul>
<li><p><strong>socket()：</strong> 该函数用于建立一个 socket 连接， 可指定 socket 类型等信息。 在建立了 socket 连接之后，<br>可对 sockaddr 或 sockaddr_in 结构进行初始化，以保存所建立的 socket 地址信息。</p>
</li>
<li><p><strong>bind()：</strong>该函数是用于将本地 IP 地址绑定到端口号，若绑定其他 IP 地址则不能成功。另外，它主<br>要用于 TCP 的连接，而在 UDP 的连接中则无必要。</p>
</li>
<li><p><strong>listen()：</strong>在服务端程序成功建立套接字和与地址进行绑定之后，还需要准备在该套接字上接收新<br>的连接请求。此时调用 listen()函数来创建一个等待队列，在其中存放未处理的客户端连接请求。</p>
</li>
<li><p><strong>accept()：</strong>服务端程序调用 listen()函数创建等待队列之后，调用 accept()函数等待并接收客户端的<br>连接请求。它通常从由 bind()所创建的等待队列中取出第一个未处理的连接请求。</p>
</li>
<li><p><strong>connect()：</strong>该函数在 TCP 中是用于 bind()的之后的 client 端，用于与服务器端建立连接，而在 UDP<br>中由于没有了 bind()函数，因此用 connect()有点类似 bind()函数的作用。</p>
</li>
<li><p><strong>send()和 recv()：</strong>这两个函数分别用于发送和接收数据，可以用在 TCP 中，也可以用在 UDP 中。<br>当用在 UDP 时，可以在 connect()函数建立连接之后再用。</p>
</li>
<li><p><strong>sendto()和 recvfrom()：</strong> 这两个函数的作用与 send()和 recv()函数类似， 也可以用在 TCP 和 UDP 中。<br>当用在 TCP 时，后面的几个与地址有关参数不起作用，函数作用等同于 send()和 recv()；当用在<br>UDP 时，可以用在之前没有使用 connect()的情况下，这两个函数可以自动寻找指定地址并进行连接。</p>
<p>服务器端和客户端使用 TCP 协议的流程如图 </p>
<p><img src="D:\MyBlog\图片\Snipaste_2019-03-05_16-08-41.png" alt="Snipaste_2019-03-05_16-08-41"></p>
<p>服务器端和客户端使用 UDP 协议的流程如图 </p>
<p> <img src="D:\MyBlog\图片\Snipaste_2019-03-05_16-08-24.png" alt="Snipaste_2019-03-05_16-08-24"></p>
</li>
</ul>
<h3 id="函数格式分析"><a href="#函数格式分析" class="headerlink" title="函数格式分析"></a>函数格式分析</h3><p>socket() </p>
<p><img src="D:\MyBlog\图片\Snipaste_2019-03-05_14-28-51.png" alt="Snipaste_2019-03-05_14-28-51"></p>
<p>bind() </p>
<p><img src="D:\MyBlog\图片\Snipaste_2019-03-05_14-31-47.png" alt="Snipaste_2019-03-05_14-31-47"></p>
<p>listen() </p>
<p><img src="D:\MyBlog\图片\Snipaste_2019-03-05_14-29-05.png" alt="Snipaste_2019-03-05_14-29-05"></p>
<p>accept() </p>
<p><img src="D:\MyBlog\图片\Snipaste_2019-03-05_14-29-12.png" alt="Snipaste_2019-03-05_14-29-12"></p>
<p>connect() </p>
<p><img src="D:\MyBlog\图片\Snipaste_2019-03-05_14-29-19.png" alt="Snipaste_2019-03-05_14-29-19"></p>
<p>send() </p>
<p><img src="D:\MyBlog\图片\Snipaste_2019-03-05_14-29-27.png" alt="Snipaste_2019-03-05_14-29-27"></p>
<p>recv() </p>
<p><img src="D:\MyBlog\图片\Snipaste_2019-03-05_14-29-33.png" alt="Snipaste_2019-03-05_14-29-33"></p>
<p>sendto() </p>
<p><img src="D:\MyBlog\图片\Snipaste_2019-03-05_14-29-42.png" alt="Snipaste_2019-03-05_14-29-42"></p>
<p>recvfrom() </p>
<p><img src="D:\MyBlog\图片\Snipaste_2019-03-05_14-29-49.png" alt="Snipaste_2019-03-05_14-29-49"></p>
<h3 id="编程实战"><a href="#编程实战" class="headerlink" title="编程实战"></a>编程实战</h3><h4 id="TCP-1"><a href="#TCP-1" class="headerlink" title="TCP"></a>TCP</h4><p>代码参考：<a href="https://www.cnblogs.com/lihaibo-Leao/p/3981955.html" target="_blank" rel="noopener">Linux C Socket编程原理及简单实例</a></p>
<p>程序为简单的“回射”，客户端将控制台输入的信息发送给服务器端，服务器原样返回信息。</p>
<p>服务器端</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;sys/types.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;sys/socket.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;netinet/in.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;arpa/inet.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;fcntl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;sys/shm.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> MYPORT  8887</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> QUEUE   20</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> BUFFER_SIZE 1024</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"><span class="comment">//第一步socket()</span></span><br><span class="line">    <span class="comment">///定义sockfd   </span></span><br><span class="line">    <span class="keyword">int</span> server_sockfd = socket(AF_INET,SOCK_STREAM, <span class="number">0</span>);<span class="comment">//ipv4，流式套接字</span></span><br><span class="line"></span><br><span class="line">	</span><br><span class="line"><span class="comment">//第二步：bind()</span></span><br><span class="line">    <span class="comment">///定义sockaddr_in结构体参数</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">sockaddr_in</span> <span class="title">server_sockaddr</span>;</span></span><br><span class="line">    server_sockaddr.sin_family = AF_INET;  <span class="comment">//IPV4地址族</span></span><br><span class="line">    server_sockaddr.sin_port = htons(MYPORT);<span class="comment">//8887端口号，htons()将主机字节转为网络字节</span></span><br><span class="line">    server_sockaddr.sin_addr.s_addr = htonl(INADDR_ANY);<span class="comment">/*INADDR_ANY)：任意ip地址*/</span></span><br><span class="line">	bzero(&amp;(server_sockaddr.sin_zero), <span class="number">8</span>);<span class="comment">/*填充 0 以保持与 struct sockaddr 同样大小*/</span></span><br><span class="line">     </span><br><span class="line">    <span class="comment">///bind，成功返回0，出错返回-1</span></span><br><span class="line">    <span class="keyword">if</span>(bind(server_sockfd,(struct sockaddr *)&amp;server_sockaddr,<span class="keyword">sizeof</span>(server_sockaddr))==<span class="number">-1</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        perror(<span class="string">"bind"</span>);</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">1</span>);</span><br><span class="line">    &#125;</span><br><span class="line">	</span><br><span class="line"><span class="comment">//第三步：listen()	</span></span><br><span class="line">    <span class="comment">///listen，成功返回0，出错返回-1</span></span><br><span class="line">    <span class="keyword">if</span>(listen(server_sockfd,QUEUE) == <span class="number">-1</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        perror(<span class="string">"listen"</span>);</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">1</span>);</span><br><span class="line">    &#125;</span><br><span class="line">	</span><br><span class="line"><span class="comment">//第四步accept()</span></span><br><span class="line">    <span class="comment">///客户端套接字</span></span><br><span class="line">  </span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">sockaddr_in</span> <span class="title">client_addr</span>;</span></span><br><span class="line">    <span class="keyword">socklen_t</span> length = <span class="keyword">sizeof</span>(client_addr);</span><br><span class="line"></span><br><span class="line">    <span class="comment">///成功返回非负描述字，出错返回-1</span></span><br><span class="line">    <span class="keyword">int</span> conn = accept(server_sockfd, (struct sockaddr*)&amp;client_addr, &amp;length);</span><br><span class="line">    <span class="keyword">if</span>(conn&lt;<span class="number">0</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        perror(<span class="string">"connect"</span>);</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">1</span>);</span><br><span class="line">    &#125;</span><br><span class="line">	</span><br><span class="line"></span><br><span class="line"><span class="comment">//第五到七步：recv()&amp;send()&amp;close();</span></span><br><span class="line">  <span class="keyword">char</span> buffer[BUFFER_SIZE];	</span><br><span class="line">    <span class="keyword">while</span>(<span class="number">1</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">memset</span>(buffer,<span class="number">0</span>,<span class="keyword">sizeof</span>(buffer));<span class="comment">//为申请的内存做初始化工作</span></span><br><span class="line">        <span class="keyword">int</span> len = recv(conn, buffer, <span class="keyword">sizeof</span>(buffer),<span class="number">0</span>);<span class="comment">//接收客户端数据</span></span><br><span class="line">        <span class="keyword">if</span>(<span class="built_in">strcmp</span>(buffer,<span class="string">"exit\n"</span>)==<span class="number">0</span>)</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="built_in">fputs</span>(buffer, <span class="built_in">stdout</span>);<span class="comment">//把接受到数据打印到显示屏</span></span><br><span class="line">        send(conn, buffer, len, <span class="number">0</span>);<span class="comment">//重新发送接收收据到客户端</span></span><br><span class="line">    &#125;</span><br><span class="line">    close(conn);<span class="comment">//关闭客户端套接字描述符</span></span><br><span class="line">    close(server_sockfd);<span class="comment">//关闭服务端套接字描述符</span></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>客服端：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/types.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/socket.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;netinet/in.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;arpa/inet.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;fcntl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/shm.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> MYPORT  8887</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> BUFFER_SIZE 1024</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	</span><br><span class="line"><span class="comment">//第一步SOCKET();	</span></span><br><span class="line">    <span class="comment">///定义sockfd</span></span><br><span class="line">    <span class="keyword">int</span> sock_cli = socket(AF_INET,SOCK_STREAM, <span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">///定义sockaddr_in</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">sockaddr_in</span> <span class="title">servaddr</span>;</span></span><br><span class="line">    <span class="built_in">memset</span>(&amp;servaddr, <span class="number">0</span>, <span class="keyword">sizeof</span>(servaddr));</span><br><span class="line">    servaddr.sin_family = AF_INET; <span class="comment">//IPV4</span></span><br><span class="line">    servaddr.sin_port = htons(MYPORT);  <span class="comment">///服务器端口:8887</span></span><br><span class="line">    servaddr.sin_addr.s_addr = inet_addr(<span class="string">"127.0.0.1"</span>);  <span class="comment">///服务器ip</span></span><br><span class="line">	</span><br><span class="line"><span class="comment">//bind()一般不需要;客户端用bind的程序很容易出问题，指定的容易冲突？</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//第二步：connect();	</span></span><br><span class="line">    <span class="comment">///连接服务器，成功返回0，错误返回-1</span></span><br><span class="line">    <span class="keyword">if</span> (connect(sock_cli, (struct sockaddr *)&amp;servaddr, <span class="keyword">sizeof</span>(servaddr)) &lt; <span class="number">0</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        perror(<span class="string">"connect"</span>);</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">1</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//第三步到第五步：send()&amp;recv()&amp;close();</span></span><br><span class="line">    <span class="keyword">char</span> sendbuf[BUFFER_SIZE];</span><br><span class="line">    <span class="keyword">char</span> recvbuf[BUFFER_SIZE];</span><br><span class="line">    <span class="keyword">while</span> (fgets(sendbuf, <span class="keyword">sizeof</span>(sendbuf), <span class="built_in">stdin</span>) != <span class="literal">NULL</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        send(sock_cli, sendbuf, <span class="built_in">strlen</span>(sendbuf),<span class="number">0</span>); <span class="comment">///发送</span></span><br><span class="line">        <span class="keyword">if</span>(<span class="built_in">strcmp</span>(sendbuf,<span class="string">"exit\n"</span>)==<span class="number">0</span>)</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        recv(sock_cli, recvbuf, <span class="keyword">sizeof</span>(recvbuf),<span class="number">0</span>); <span class="comment">///接收</span></span><br><span class="line">        <span class="built_in">fputs</span>(recvbuf, <span class="built_in">stdout</span>);</span><br><span class="line"></span><br><span class="line">        <span class="built_in">memset</span>(sendbuf, <span class="number">0</span>, <span class="keyword">sizeof</span>(sendbuf));</span><br><span class="line">        <span class="built_in">memset</span>(recvbuf, <span class="number">0</span>, <span class="keyword">sizeof</span>(recvbuf));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    close(sock_cli);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>结果：客户端发送数据给服务端，服务端收到数据显示并再次发送回客户端，客户端收到并显示。</p>
<p><img src="D:\MyBlog\图片\Snipaste_2019-03-05_16-23-50.png" alt="Snipaste_2019-03-05_16-23-50"></p>
<h4 id="UDP-1"><a href="#UDP-1" class="headerlink" title="UDP"></a>UDP</h4><p>参考：<a href="https://www.cnblogs.com/skyfsm/p/6287787.html" target="_blank" rel="noopener">Linux编程之UDP SOCKET全攻略</a></p>
<p>Server</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/types.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/socket.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;netinet/in.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;string.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> SERVER_PORT 8888</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> BUFF_LEN 1024</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">handle_udp_msg</span><span class="params">(<span class="keyword">int</span> fd)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">char</span> buf[BUFF_LEN];  <span class="comment">//接收缓冲区，1024字节</span></span><br><span class="line">    <span class="keyword">socklen_t</span> len;</span><br><span class="line">    <span class="keyword">int</span> count;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">sockaddr_in</span> <span class="title">clent_addr</span>;</span>  <span class="comment">//clent_addr用于记录发送方的地址信息</span></span><br><span class="line">    <span class="keyword">while</span>(<span class="number">1</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">memset</span>(buf, <span class="number">0</span>, BUFF_LEN);</span><br><span class="line">        len = <span class="keyword">sizeof</span>(clent_addr);</span><br><span class="line">        count = recvfrom(fd, buf, BUFF_LEN, <span class="number">0</span>, (struct sockaddr*)&amp;clent_addr, &amp;len);  <span class="comment">//recvfrom是拥塞函数，没有数据就一直拥塞</span></span><br><span class="line">        <span class="keyword">if</span>(count == <span class="number">-1</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">"recieve data fail!\n"</span>);</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">"client:%s\n"</span>,buf);  <span class="comment">//打印client发过来的信息</span></span><br><span class="line">        <span class="built_in">memset</span>(buf, <span class="number">0</span>, BUFF_LEN);</span><br><span class="line">        <span class="built_in">sprintf</span>(buf, <span class="string">"I have recieved %d bytes data!\n"</span>, count);  <span class="comment">//回复client</span></span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">"server:%s\n"</span>,buf);  <span class="comment">//打印自己发送的信息给</span></span><br><span class="line">        sendto(fd, buf, BUFF_LEN, <span class="number">0</span>, (struct sockaddr*)&amp;clent_addr, len);  <span class="comment">//发送信息给client，注意使用了clent_addr结构体指针</span></span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">    server:</span></span><br><span class="line"><span class="comment">            socket--&gt;bind--&gt;recvfrom--&gt;sendto--&gt;close</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc, <span class="keyword">char</span>* argv[])</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">int</span> server_fd, ret;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">sockaddr_in</span> <span class="title">ser_addr</span>;</span> </span><br><span class="line"><span class="comment">//第一步：Socket();</span></span><br><span class="line">    server_fd = socket(AF_INET, SOCK_DGRAM, <span class="number">0</span>); <span class="comment">//AF_INET:IPV4;SOCK_DGRAM:UDP</span></span><br><span class="line">    <span class="keyword">if</span>(server_fd &lt; <span class="number">0</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">"create socket fail!\n"</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">memset</span>(&amp;ser_addr, <span class="number">0</span>, <span class="keyword">sizeof</span>(ser_addr));</span><br><span class="line">    ser_addr.sin_family = AF_INET;</span><br><span class="line">    ser_addr.sin_addr.s_addr = htonl(INADDR_ANY); <span class="comment">//IP地址，需要进行网络序转换，INADDR_ANY：本地地址</span></span><br><span class="line">    ser_addr.sin_port = htons(SERVER_PORT);  <span class="comment">//端口号，需要网络序转换</span></span><br><span class="line"><span class="comment">//第二步：bind();</span></span><br><span class="line">    ret = bind(server_fd, (struct sockaddr*)&amp;ser_addr, <span class="keyword">sizeof</span>(ser_addr));</span><br><span class="line">    <span class="keyword">if</span>(ret &lt; <span class="number">0</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">"socket bind fail!\n"</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    &#125;</span><br><span class="line"><span class="comment">//第三，四步：recvfrom()&amp;sedto();</span></span><br><span class="line">    handle_udp_msg(server_fd);   <span class="comment">//处理接收到的数据</span></span><br><span class="line"><span class="comment">//第五步：close（）；</span></span><br><span class="line">    close(server_fd);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>Client</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/types.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/socket.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;netinet/in.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;string.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> SERVER_PORT 8888</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> BUFF_LEN 512</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> SERVER_IP <span class="meta-string">"172.0.5.182"</span></span></span><br><span class="line"><span class="keyword">char</span> buf[BUFF_LEN];</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">  </span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">udp_msg_sender</span><span class="params">(<span class="keyword">int</span> fd, struct sockaddr* dst)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">socklen_t</span> len;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">sockaddr_in</span> <span class="title">src</span>;</span></span><br><span class="line">    <span class="keyword">while</span>(<span class="number">1</span>)</span><br><span class="line">    &#123;</span><br><span class="line">          <span class="keyword">while</span> (fgets(buf, BUFF_LEN, <span class="built_in">stdin</span>) != <span class="literal">NULL</span>)</span><br><span class="line">  	 	 &#123;</span><br><span class="line">       		 len = <span class="keyword">sizeof</span>(*dst);</span><br><span class="line">       		 <span class="built_in">printf</span>(<span class="string">"client:%s\n"</span>,buf);  <span class="comment">//打印自己发送的信息</span></span><br><span class="line">       		 sendto(fd, buf, BUFF_LEN, <span class="number">0</span>, dst, len);</span><br><span class="line">       		 <span class="built_in">memset</span>(buf, <span class="number">0</span>, BUFF_LEN);</span><br><span class="line">        	 recvfrom(fd, buf, BUFF_LEN, <span class="number">0</span>, (struct sockaddr*)&amp;src, &amp;len);  <span class="comment">//接收来自server的信息</span></span><br><span class="line">       		 <span class="built_in">printf</span>(<span class="string">"server:%s\n"</span>,buf);</span><br><span class="line">        	sleep(<span class="number">1</span>);  <span class="comment">//一秒发送一次消息</span></span><br><span class="line">   		 &#125;</span><br><span class="line">     &#125;   </span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">    client:</span></span><br><span class="line"><span class="comment">            socket--&gt;sendto--&gt;revcfrom--&gt;close</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc, <span class="keyword">char</span>* argv[])</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">int</span> client_fd;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">sockaddr_in</span> <span class="title">ser_addr</span>;</span></span><br><span class="line"></span><br><span class="line">    client_fd = socket(AF_INET, SOCK_DGRAM, <span class="number">0</span>);</span><br><span class="line">    <span class="keyword">if</span>(client_fd &lt; <span class="number">0</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">"create socket fail!\n"</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">memset</span>(&amp;ser_addr, <span class="number">0</span>, <span class="keyword">sizeof</span>(ser_addr));</span><br><span class="line">    ser_addr.sin_family = AF_INET;</span><br><span class="line">    <span class="comment">//ser_addr.sin_addr.s_addr = inet_addr(SERVER_IP);</span></span><br><span class="line">    ser_addr.sin_addr.s_addr = htonl(INADDR_ANY);  <span class="comment">//注意网络序转换</span></span><br><span class="line">    ser_addr.sin_port = htons(SERVER_PORT);  <span class="comment">//注意网络序转换</span></span><br><span class="line"></span><br><span class="line">    udp_msg_sender(client_fd, (struct sockaddr*)&amp;ser_addr);</span><br><span class="line"></span><br><span class="line">    close(client_fd);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>结果：</p>
<p><img src="D:\MyBlog\图片\Snipaste_2019-03-05_17-18-16.png" alt="Snipaste_2019-03-05_17-18-16"></p>
<h2 id="第四章：socket编程进阶"><a href="#第四章：socket编程进阶" class="headerlink" title="第四章：socket编程进阶"></a>第四章：socket编程进阶</h2><h3 id="多线程Socket"><a href="#多线程Socket" class="headerlink" title="多线程Socket"></a>多线程Socket</h3><p><a href="https://www.cnblogs.com/liangf27/p/9356837.html" target="_blank" rel="noopener">Linux下socket通信和多线程</a></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line">#include &lt;stdio.h&gt;</span><br><span class="line">#include &lt;stdlib.h&gt;</span><br><span class="line">#include &lt;sys/socket.h&gt;</span><br><span class="line">#include &lt;netinet/in.h&gt;</span><br><span class="line">#include &lt;string.h&gt;</span><br><span class="line"></span><br><span class="line">const int Port = 8888;</span><br><span class="line"></span><br><span class="line">int main(void)&#123;</span><br><span class="line">    int sock_fd;</span><br><span class="line">    struct sockaddr_in mysock;</span><br><span class="line">    struct sockaddr_in client_addr;</span><br><span class="line">    int new_fd;</span><br><span class="line">    socklen_t sin_size;</span><br><span class="line">    char buf[1024];</span><br><span class="line">    char sedbuf[1024] = &quot;recv successfully.\n&quot;;</span><br><span class="line"></span><br><span class="line">    //初始化socket</span><br><span class="line">    sock_fd = socket(AF_INET,SOCK_STREAM,0);</span><br><span class="line"></span><br><span class="line">    //编辑地址信息</span><br><span class="line">    memset(&amp;mysock,0,sizeof(mysock));</span><br><span class="line">    mysock.sin_family = AF_INET;</span><br><span class="line">    mysock.sin_port = htons(Port);</span><br><span class="line">    mysock.sin_addr.s_addr = INADDR_ANY;</span><br><span class="line"></span><br><span class="line">    //绑定地址，然后监听</span><br><span class="line">    bind(sock_fd,(struct sockaddr *)&amp;mysock,sizeof(struct sockaddr));</span><br><span class="line">    if(listen(sock_fd,10) &lt; -1)&#123;</span><br><span class="line">        printf(&quot;listen error.\n&quot;);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    sin_size = sizeof(struct sockaddr_in);</span><br><span class="line">    </span><br><span class="line">    printf(&quot;listening...\n&quot;);</span><br><span class="line">    new_fd = accept(sock_fd, (struct sockaddr *)&amp;client_addr, &amp;sin_size);//accpet</span><br><span class="line">    while(1)&#123;</span><br><span class="line">        int len = recv(new_fd,buf,sizeof(buf),0);</span><br><span class="line">        fputs(buf,stdout);</span><br><span class="line">        send(new_fd, sedbuf, sizeof(sedbuf), 0);</span><br><span class="line">        if(strcmp(buf,&quot;exit\n&quot;) == 0)&#123;</span><br><span class="line">            break;</span><br><span class="line">        &#125;</span><br><span class="line">        memset(buf,0,sizeof(buf));</span><br><span class="line">    &#125;</span><br><span class="line">    close(new_fd);</span><br><span class="line">    close(sock_fd);</span><br><span class="line">    return 0;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><a href="https://www.cnblogs.com/PengfeiSong/p/6796338.html" target="_blank" rel="noopener">socket利用多线程实现一对多通信</a></p>
<p>服务端监听某个端口，客户端连接之后发送数据——&gt;客户端断开连接后，服务端也关闭了</p>
<p>服务端：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/types.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/stat.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;fcntl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;pthread.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/socket.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;arpa/inet.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;signal.h&gt;  //处理信号问题 应忽略socket 信号</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> MY_IP     <span class="meta-string">"192.168.149.137"</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> MY_PORT  5005</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> BACKLOG  100</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> DEBUF(X) printf(X)</span></span><br><span class="line"><span class="keyword">int</span> fd = <span class="number">-1</span>;</span><br><span class="line"><span class="keyword">char</span> buf[<span class="number">100</span>];    <span class="comment">//最大连接数</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> *<span class="title">func</span><span class="params">(<span class="keyword">void</span> *arg)</span></span></span><br><span class="line"><span class="function"></span>&#123;    <span class="keyword">char</span> recv_buf[<span class="number">100</span>];</span><br><span class="line">    <span class="keyword">char</span> send_buf[<span class="number">100</span>];</span><br><span class="line">    <span class="keyword">int</span> client_fd = (<span class="keyword">int</span>)arg;<span class="comment">//传参</span></span><br><span class="line">    <span class="keyword">int</span> ret = <span class="number">1</span>;</span><br><span class="line">    <span class="built_in">memset</span>(recv_buf,<span class="number">0</span>,<span class="keyword">sizeof</span>(recv_buf));</span><br><span class="line">    <span class="keyword">while</span>(<span class="number">1</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        ret = recv(client_fd,&amp;recv_buf,<span class="keyword">sizeof</span>(recv_buf),<span class="number">0</span>);</span><br><span class="line">        <span class="keyword">if</span>(<span class="number">0</span> == ret) <span class="keyword">break</span>;<span class="comment">//阻塞等待过程中断开则会返回0</span></span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">"%s\n"</span>,recv_buf); </span><br><span class="line">        send(client_fd,&amp;recv_buf,<span class="keyword">sizeof</span>(recv_buf),<span class="number">0</span>);</span><br><span class="line">        <span class="built_in">memset</span>(recv_buf,<span class="number">0</span>,<span class="keyword">sizeof</span>(recv_buf));        </span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"over \n"</span>);</span><br><span class="line">&#125;</span><br><span class="line"> <span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;    </span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">sockaddr_in</span> <span class="title">server_addr</span>;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">sockaddr_in</span> <span class="title">client_addr</span>;</span><span class="comment">//客户地址</span></span><br><span class="line">    <span class="keyword">socklen_t</span> len = <span class="number">0</span>;<span class="comment">//接收长度</span></span><br><span class="line">    <span class="keyword">char</span> recv_buf[<span class="number">100</span>];</span><br><span class="line">    <span class="keyword">char</span> send_buf[<span class="number">100</span>];</span><br><span class="line">    <span class="keyword">int</span> sock_fd = <span class="number">-1</span>;<span class="comment">//监听描述符</span></span><br><span class="line">    <span class="keyword">int</span> client_fd = <span class="number">-1</span>;<span class="comment">//连接fd</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">int</span> ret = <span class="number">-1</span>;</span><br><span class="line">    <span class="keyword">pthread_t</span> th =<span class="number">-1</span> ;</span><br><span class="line">    </span><br><span class="line">    signal(SIGPIPE, SIG_IGN);<span class="comment">//忽略管道破裂信号</span></span><br><span class="line">    sock_fd = socket(AF_INET,SOCK_STREAM,<span class="number">0</span>);</span><br><span class="line">    <span class="keyword">if</span>(<span class="number">-1</span> == sock_fd)</span><br><span class="line">    &#123;</span><br><span class="line">        perror(<span class="string">"socket"</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"sock_fd = %d.\n"</span>,sock_fd);</span><br><span class="line">    <span class="comment">//2.bind绑定socket 和本机IP 端口</span></span><br><span class="line">    server_addr.sin_family = AF_INET;<span class="comment">//IPV4</span></span><br><span class="line">    server_addr.sin_port = htons(MY_PORT);<span class="comment">//设置端口模式</span></span><br><span class="line">    server_addr.sin_addr.s_addr = inet_addr(MY_IP);<span class="comment">//设置IP</span></span><br><span class="line">    ret = bind(sock_fd,(struct  sockaddr  *)&amp;server_addr,<span class="keyword">sizeof</span>(server_addr));</span><br><span class="line">    <span class="keyword">if</span>(<span class="number">-1</span> == ret)</span><br><span class="line">    &#123;</span><br><span class="line">        perror(<span class="string">"bind"</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    DEBUF(<span class="string">"bind ok\n"</span>);</span><br><span class="line">    <span class="comment">//3.listen 设 置监听</span></span><br><span class="line">    ret = listen(sock_fd, BACKLOG);<span class="comment">//BACKLOG为排队处理</span></span><br><span class="line">    <span class="keyword">if</span>(<span class="number">-1</span> == ret)</span><br><span class="line">    &#123;</span><br><span class="line">        perror(<span class="string">"listen"</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    DEBUF(<span class="string">"listen ok\n"</span>);</span><br><span class="line">    <span class="keyword">while</span>(<span class="number">1</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        client_fd = accept(sock_fd, (struct sockaddr *)&amp;client_addr, &amp;len);</span><br><span class="line">        <span class="keyword">if</span>(<span class="number">-1</span> == client_fd)</span><br><span class="line">        &#123;</span><br><span class="line">            perror(<span class="string">"listen"</span>);</span><br><span class="line">            <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        ret = pthread_create(&amp;th ,<span class="literal">NULL</span> , func , (<span class="keyword">void</span>*)client_fd);<span class="comment">//创建线程</span></span><br><span class="line">        DEBUF(<span class="string">"新用户加入\n"</span>);</span><br><span class="line">         <span class="keyword">if</span>(ret != <span class="number">0</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">"pthread_create error \n"</span>);</span><br><span class="line">            <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">        &#125; </span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure>
<p>客户端：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;sys/types.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;sys/socket.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;netinet/in.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;netdb.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;errno.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> <span class="keyword">int</span> Port = <span class="number">8888</span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">void</span>)</span></span>&#123;</span><br><span class="line">    <span class="keyword">int</span> sock_fd;</span><br><span class="line">    <span class="keyword">char</span> buf[<span class="number">1024</span>], sendbuf[<span class="number">1024</span>], recvbuf[<span class="number">1024</span>];</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">sockaddr_in</span> <span class="title">server_addr</span>;</span></span><br><span class="line">    sock_fd = socket(AF_INET, SOCK_STREAM, <span class="number">0</span>);<span class="comment">//初始化socket</span></span><br><span class="line">    <span class="keyword">if</span>(sock_fd == <span class="number">-1</span>)&#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">"%s\n"</span>,strerror(errno));</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    bzero(&amp;server_addr, <span class="keyword">sizeof</span>(server_addr));<span class="comment">//编辑服务端地址信息</span></span><br><span class="line">    server_addr.sin_family = AF_INET;</span><br><span class="line">    server_addr.sin_port = htons(Port);</span><br><span class="line">    server_addr.sin_addr.s_addr = htonl(INADDR_ANY);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">int</span> tmp = connect(sock_fd, (struct sockaddr *)(&amp;server_addr), </span><br><span class="line">        <span class="keyword">sizeof</span>(struct sockaddr));<span class="comment">//连接服务端socket</span></span><br><span class="line">    <span class="keyword">if</span>(tmp == <span class="number">-1</span>)&#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">"%s\n"</span>,strerror(errno));</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">while</span>(<span class="number">1</span>)&#123;</span><br><span class="line">        fgets(sendbuf, <span class="keyword">sizeof</span>(sendbuf), <span class="built_in">stdin</span>);</span><br><span class="line">        send(sock_fd, sendbuf, <span class="built_in">strlen</span>(sendbuf), <span class="number">0</span>);</span><br><span class="line">        <span class="keyword">if</span>(<span class="built_in">strcmp</span>(sendbuf, <span class="string">"exit\n"</span>) == <span class="number">0</span>)</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        recv(sock_fd, recvbuf, <span class="keyword">sizeof</span>(recvbuf), <span class="number">0</span>);</span><br><span class="line">        <span class="built_in">fputs</span>(recvbuf, <span class="built_in">stdout</span>);</span><br><span class="line">        <span class="built_in">memset</span>(sendbuf, <span class="number">0</span>, <span class="keyword">sizeof</span>(sendbuf));</span><br><span class="line">        <span class="built_in">memset</span>(recvbuf, <span class="number">0</span>, <span class="keyword">sizeof</span>(recvbuf));</span><br><span class="line">    &#125;</span><br><span class="line">    close(sock_fd);</span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>服务端：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/socket.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;netinet/in.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;pthread.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;unistd.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> <span class="keyword">int</span> Port = <span class="number">8888</span>;</span><br><span class="line"><span class="keyword">pthread_mutex_t</span> g_mutext;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">pthread_data</span>&#123;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">sockaddr_in</span> <span class="title">client_addr</span>;</span></span><br><span class="line">    <span class="keyword">int</span> sock_fd;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> *<span class="title">serveForClient</span><span class="params">(<span class="keyword">void</span> * arg)</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">void</span>)</span></span>&#123;</span><br><span class="line">    <span class="keyword">int</span> sock_fd;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">sockaddr_in</span> <span class="title">mysock</span>;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">pthread_data</span> <span class="title">pdata</span>;</span></span><br><span class="line">    <span class="keyword">pthread_t</span> pt;</span><br><span class="line">    <span class="keyword">socklen_t</span> sin_size = <span class="keyword">sizeof</span>(struct sockaddr_in);</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">sockaddr_in</span> <span class="title">client_addr</span>;</span></span><br><span class="line">    <span class="keyword">int</span> new_fd;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//初始化socket</span></span><br><span class="line">    sock_fd = socket(AF_INET,SOCK_STREAM,<span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//编辑地址信息</span></span><br><span class="line">    <span class="built_in">memset</span>(&amp;mysock, <span class="number">0</span>, <span class="keyword">sizeof</span>(mysock));</span><br><span class="line">    mysock.sin_family = AF_INET;</span><br><span class="line">    mysock.sin_port = htons(Port);</span><br><span class="line">    mysock.sin_addr.s_addr = INADDR_ANY;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//绑定地址，然后监听</span></span><br><span class="line">    bind(sock_fd,(struct sockaddr *)&amp;mysock,<span class="keyword">sizeof</span>(struct sockaddr));</span><br><span class="line">    <span class="keyword">if</span>(listen(sock_fd,<span class="number">10</span>) &lt; <span class="number">-1</span>)&#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">"listen error.\n"</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"listening...\n"</span>);</span><br><span class="line">    <span class="keyword">while</span>(<span class="number">1</span>)&#123;</span><br><span class="line">        <span class="comment">//accpet</span></span><br><span class="line">        new_fd = accept(sock_fd, (struct sockaddr *)&amp;client_addr, &amp;sin_size);</span><br><span class="line">        pdata.client_addr = client_addr;</span><br><span class="line">        pdata.sock_fd = new_fd;</span><br><span class="line">        pthread_create(&amp;pt, <span class="literal">NULL</span>, serveForClient, (<span class="keyword">void</span> *)&amp;pdata);</span><br><span class="line">    &#125;</span><br><span class="line">    close(new_fd);</span><br><span class="line">    close(sock_fd);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> *<span class="title">serveForClient</span><span class="params">(<span class="keyword">void</span> *arg)</span></span>&#123;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">pthread_data</span> *<span class="title">pdata</span> = (<span class="title">struct</span> <span class="title">pthread_data</span>*)<span class="title">arg</span>;</span></span><br><span class="line">    <span class="keyword">int</span> new_fd = pdata-&gt;sock_fd;</span><br><span class="line">    <span class="keyword">char</span> recvbuf[<span class="number">1024</span>];</span><br><span class="line">    <span class="keyword">char</span> sendbuf[<span class="number">1024</span>] = <span class="string">"recv successfully.\n"</span>;</span><br><span class="line">    <span class="keyword">while</span>(<span class="number">1</span>)&#123;</span><br><span class="line">        recv(new_fd, recvbuf, <span class="keyword">sizeof</span>(recvbuf), <span class="number">0</span>);</span><br><span class="line">        <span class="built_in">fputs</span>(recvbuf,<span class="built_in">stdout</span>);</span><br><span class="line">        <span class="built_in">strcpy</span>(sendbuf, recvbuf);</span><br><span class="line">        <span class="keyword">if</span>(<span class="built_in">strcmp</span>(recvbuf,<span class="string">"exit\n"</span>) == <span class="number">0</span>)&#123;</span><br><span class="line">            send(new_fd, <span class="string">"connection close.\n"</span>, <span class="keyword">sizeof</span>(<span class="string">"connection close.\n"</span>), <span class="number">0</span>);</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        send(new_fd, sendbuf, <span class="keyword">sizeof</span>(sendbuf), <span class="number">0</span>);</span><br><span class="line">        <span class="built_in">memset</span>(recvbuf,<span class="number">0</span>,<span class="keyword">sizeof</span>(recvbuf));</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//close(new_fd);评论中指出多了一次close，所以这里不close了，留待main函数中统一close</span></span><br><span class="line">    pthread_exit(<span class="number">0</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>；</p>

      
    </div>

    

    
    
    

    

    

    

    <footer class="post-footer">
      

      
      
      

      
        <div class="post-nav">
          <div class="post-nav-next post-nav-item">
            
              <a href="/进程与线程.html" rel="next" title="进程与线程">
                <i class="fa fa-chevron-left"></i> 进程与线程
              </a>
            
          </div>

          <span class="post-nav-divider"></span>

          <div class="post-nav-prev post-nav-item">
            
              <a href="/Linux设备驱动开发详解：基于最新的Linux4-0内核.html" rel="prev" title="Linux设备驱动开发详解：基于最新的Linux4.0内核">
                Linux设备驱动开发详解：基于最新的Linux4.0内核 <i class="fa fa-chevron-right"></i>
              </a>
            
          </div>
        </div>
      

      
      
    </footer>
  </div>
  
  
  
  </article>


  </div>


          </div>
          

  



        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      
        <ul class="sidebar-nav motion-element">
          <li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap">
            文章目录
          </li>
          <li class="sidebar-nav-overview" data-target="site-overview-wrap">
            站点概览
          </li>
        </ul>
      

      <section class="site-overview-wrap sidebar-panel">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope="" itemtype="http://schema.org/Person">
            
              <img class="site-author-image" itemprop="image" src="/images/avatar.jpg" alt="Jeff Wu">
            
              <p class="site-author-name" itemprop="name">Jeff Wu</p>
              <p class="site-description motion-element" itemprop="description"></p>
          </div>

          
            <nav class="site-state motion-element">
              
                <div class="site-state-item site-state-posts">
                
                  <a href="/archives/">
                
                    <span class="site-state-item-count">41</span>
                    <span class="site-state-item-name">日志</span>
                  </a>
                </div>
              

              
                
                
                <div class="site-state-item site-state-categories">
                  <a href="/categories/index.html">
                    
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                    <span class="site-state-item-count">10</span>
                    <span class="site-state-item-name">分类</span>
                  </a>
                </div>
              

              
                
                
                <div class="site-state-item site-state-tags">
                  <a href="/tags/index.html">
                    
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                    <span class="site-state-item-count">8</span>
                    <span class="site-state-item-name">标签</span>
                  </a>
                </div>
              
            </nav>
          

          
            <div class="feed-link motion-element">
              <a href="/atom.xml" rel="alternate">
                <i class="fa fa-rss"></i>
                RSS
              </a>
            </div>
          

          
            <div class="links-of-author motion-element">
              
                <span class="links-of-author-item">
                  <a href="https://github.com/SetCalm" target="_blank" title="GitHub"><i class="fa fa-fw fa-globe"></i>GitHub</a>
                  
                </span>
              
                <span class="links-of-author-item">
                  <a href="https://www.zhihu.com/people/calm-16-25/activities" target="_blank" title="知乎"><i class="fa fa-fw fa-globe"></i>知乎</a>
                  
                </span>
              
            </div>
          

          
          

          
          

          
            
          
          

        </div>
      </section>

      
      <!--noindex-->
        <section class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active">
          <div class="post-toc">

            
              
            

            
              <div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#嵌入式-Linux-网络编程"><span class="nav-number">1.</span> <span class="nav-text">嵌入式 Linux 网络编程</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#第一章：TCP-IP-协议简介"><span class="nav-number">1.1.</span> <span class="nav-text">第一章：TCP/IP 协议简介</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#TCP-IP-协议概述"><span class="nav-number">1.1.1.</span> <span class="nav-text">TCP/IP 协议概述</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#OSI-参考模型及-TCP-IP-参考模型"><span class="nav-number">1.1.1.1.</span> <span class="nav-text">OSI 参考模型及 TCP/IP 参考模型</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#TCP-IP-的-4-层模型进行简要介绍"><span class="nav-number">1.1.1.2.</span> <span class="nav-text">TCP/IP 的 4 层模型进行简要介绍</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#TCP-IP概述"><span class="nav-number">1.1.1.3.</span> <span class="nav-text">TCP/IP概述</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#TCP"><span class="nav-number">1.1.2.</span> <span class="nav-text">TCP</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#TCP数据报头"><span class="nav-number">1.1.2.1.</span> <span class="nav-text">TCP数据报头</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#IP数据报头"><span class="nav-number">1.1.2.2.</span> <span class="nav-text">IP数据报头</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#三次握手"><span class="nav-number">1.1.2.3.</span> <span class="nav-text">三次握手</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#四步挥手"><span class="nav-number">1.1.2.4.</span> <span class="nav-text">四步挥手</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#UDP"><span class="nav-number">1.1.3.</span> <span class="nav-text">UDP</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#第二章：网络编程基础"><span class="nav-number">1.2.</span> <span class="nav-text">第二章：网络编程基础</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#套接字描述符"><span class="nav-number">1.2.1.</span> <span class="nav-text">套接字描述符</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#socket-概述"><span class="nav-number">1.2.2.</span> <span class="nav-text">socket 概述</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#字节序"><span class="nav-number">1.2.3.</span> <span class="nav-text">字节序</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#IP地址格式"><span class="nav-number">1.2.4.</span> <span class="nav-text">IP地址格式</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#IP地址的作用"><span class="nav-number">1.2.4.1.</span> <span class="nav-text">IP地址的作用</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#IP地址转换函数"><span class="nav-number">1.2.4.2.</span> <span class="nav-text">IP地址转换函数</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#名字地址转化"><span class="nav-number">1.2.5.</span> <span class="nav-text">名字地址转化</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#第三章：socket编程实战"><span class="nav-number">1.3.</span> <span class="nav-text">第三章：socket编程实战</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#编程步骤"><span class="nav-number">1.3.1.</span> <span class="nav-text">编程步骤</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#函数格式分析"><span class="nav-number">1.3.2.</span> <span class="nav-text">函数格式分析</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#编程实战"><span class="nav-number">1.3.3.</span> <span class="nav-text">编程实战</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#TCP-1"><span class="nav-number">1.3.3.1.</span> <span class="nav-text">TCP</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#UDP-1"><span class="nav-number">1.3.3.2.</span> <span class="nav-text">UDP</span></a></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#第四章：socket编程进阶"><span class="nav-number">1.4.</span> <span class="nav-text">第四章：socket编程进阶</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#多线程Socket"><span class="nav-number">1.4.1.</span> <span class="nav-text">多线程Socket</span></a></li></ol></li></ol></li></ol></div>
            

          </div>
        </section>
      <!--/noindex-->
      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <script async src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>
<div class="copyright"> &copy; <span itemprop="copyrightYear">2019</span>
  <span class="with-love" id="animate">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Jeff Wu</span>

  

  
</div>

<div class="powered-by">
<i class="fa fa-user-md"></i><span id="busuanzi_container_site_uv">
  本站访客数:<span id="busuanzi_value_site_uv"></span>
</span>
</div>





  <div class="powered-by">由 <a class="theme-link" target="_blank" href="https://hexo.io">Hexo</a> 强力驱动 v3.8.0</div>



  <span class="post-meta-divider">|</span>



  <div class="theme-info">主题 – <a class="theme-link" target="_blank" href="https://theme-next.org">NexT.Mist</a> v6.5.0</div>




        








        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

    
	
    

    
  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>


























  
  
    <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>
  


  


  <script type="text/javascript" src="/js/src/utils.js?v=6.5.0"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=6.5.0"></script>



  
  

  
  <script type="text/javascript" src="/js/src/scrollspy.js?v=6.5.0"></script>
<script type="text/javascript" src="/js/src/post-details.js?v=6.5.0"></script>



  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=6.5.0"></script>



  



  










  





  

  

  

  

  

  
  

  

  

  

  

  

</body>
</html>
